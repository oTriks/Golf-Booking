@page "/"
@inject HttpClient Http
@inject GolfBookingUI.Services.AuthService AuthService
@using GolfBooking.Shared.Dtos

<h3>User Login</h3>

<EditForm Model="loginModel" OnValidSubmit="HandleLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label>Username:</label>
        <InputText @bind-Value="loginModel.Username" />
    </div>
    <div>
        <label>Password:</label>
        <InputText @bind-Value="loginModel.Password" type="password" />
    </div>
    <button type="submit">Login</button>
</EditForm>

@if (!string.IsNullOrEmpty(token))
{
    <p><strong>Token:</strong> @token</p>
}

@if (!string.IsNullOrEmpty(message))
{
    <p>@message</p>
}

@code {
    private LoginRequest loginModel = new LoginRequest { Username = string.Empty, Password = string.Empty };
    private string? token;
    private string? message;

    private async Task HandleLogin()
    {
        var response = await Http.PostAsJsonAsync("api/User/login", loginModel);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<TokenResult>();
            token = result?.token;
            message = "Login successful.";

            AuthService.SetAuthenticationState(token, loginModel.Username);
            StateHasChanged();
        }
        else
        {
            message = $"Login failed: {await response.Content.ReadAsStringAsync()}";
        }
    }


    private class TokenResult
    {
        public string? token { get; set; }
    }
}